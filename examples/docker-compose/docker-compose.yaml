# Ruriko Docker Compose Stack
#
# Copy .env.example → .env, fill in the required values, then run:
#   docker compose up -d
#
# Services:
#   ruriko   - The Ruriko control plane
#   tuwunel  - A local Matrix homeserver
#
# Volumes:
#   ruriko-data     - SQLite database and persistent state
#   tuwunel-data    - Tuwunel homeserver data
#
# Tuwunel is a lightweight, self-hostable Matrix homeserver written in Rust.
# Federation and registration are disabled by default for security.
# See OPERATIONS.md for full setup instructions.

networks:
  ruriko-net:
    driver: bridge

volumes:
  ruriko-data:
  tuwunel-data:

services:

  # --------------------------------------------------------------------------
  # Ruriko — control plane
  # --------------------------------------------------------------------------
  ruriko:
    image: ruriko:latest
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.ruriko
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_TAG: ${GIT_TAG:-v0.0.0}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    container_name: ruriko
    restart: unless-stopped
    depends_on:
      tuwunel:
        condition: service_healthy

    # Expose the optional health/status endpoint.
    # Remove this block if you set HTTP_ADDR to an empty string.
    ports:
      - "${HTTP_ADDR_HOST:-127.0.0.1}:${HTTP_ADDR_PORT:-8080}:8080"

    environment:
      # --- Matrix connection (required) ---
      MATRIX_HOMESERVER:      ${MATRIX_HOMESERVER}
      MATRIX_USER_ID:         ${MATRIX_USER_ID}
      MATRIX_ACCESS_TOKEN:    ${MATRIX_ACCESS_TOKEN}
      MATRIX_ADMIN_ROOMS:     ${MATRIX_ADMIN_ROOMS}

      # --- Encryption (required) ---
      # Generate with:  openssl rand -hex 32
      RURIKO_MASTER_KEY:      ${RURIKO_MASTER_KEY}

      # --- Optional Matrix settings ---
      MATRIX_ADMIN_SENDERS:   ${MATRIX_ADMIN_SENDERS:-}
      MATRIX_AUDIT_ROOM:      ${MATRIX_AUDIT_ROOM:-}

      # --- Kuze (one-time secret entry) ---
      # Set to the externally reachable base URL of Ruriko's HTTP server.
      # When set, /ruriko secrets set generates browser links instead of accepting inline values.
      KUZE_BASE_URL:                     ${KUZE_BASE_URL:-}
      KUZE_TTL:                          ${KUZE_TTL:-10m}

      # --- Default agent image ---
      DEFAULT_AGENT_IMAGE:               ${DEFAULT_AGENT_IMAGE:-gitai:latest}

      # --- Optional Matrix provisioning (account creation) ---
      MATRIX_PROVISIONING_ENABLE:      ${MATRIX_PROVISIONING_ENABLE:-false}
      MATRIX_HOMESERVER_TYPE:          ${MATRIX_HOMESERVER_TYPE:-tuwunel}
      MATRIX_SHARED_SECRET:            ${MATRIX_SHARED_SECRET:-}
      TUWUNEL_REGISTRATION_TOKEN:      ${TUWUNEL_REGISTRATION_TOKEN:-}
      MATRIX_AGENT_USERNAME_SUFFIX:    ${MATRIX_AGENT_USERNAME_SUFFIX:-}

      # --- Docker runtime (optional) ---
      DOCKER_ENABLE:          ${DOCKER_ENABLE:-false}
      DOCKER_NETWORK:         ${DOCKER_NETWORK:-ruriko-net}

      # --- Storage ---
      DATABASE_PATH:          /data/ruriko.db
      TEMPLATES_DIR:          /templates

      # --- Reconciler ---
      RECONCILE_INTERVAL:     ${RECONCILE_INTERVAL:-30s}

      # --- Health endpoint ---
      HTTP_ADDR:              :8080

      # --- Logging ---
      LOG_LEVEL:              ${LOG_LEVEL:-info}
      LOG_FORMAT:             ${LOG_FORMAT:-json}

    volumes:
      # Persist database across restarts.
      - ruriko-data:/data
      # Agent Gosuto templates — mount your custom templates/ directory here.
      - ../../templates:/templates:ro
      # Allow Ruriko to manage Docker containers on the host.
      # Remove this volume binding if DOCKER_ENABLE=false.
      - /var/run/docker.sock:/var/run/docker.sock:ro

    networks:
      - ruriko-net

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # Tuwunel — local Matrix homeserver (default)
  #
  # Tuwunel (https://tuwunel.chat) is a lightweight Matrix homeserver in Rust.
  # Federation and registration are OFF for security (single-host MVP).
  #
  # Account creation (Ruriko bot + agents):
  #   1. Set TUWUNEL_REGISTRATION_TOKEN to a random string in .env
  #   2. Start the stack: docker compose up -d tuwunel
  #   3. Register accounts using Element or the Matrix client API:
  #        POST /_matrix/client/v3/register
  #        { "username": "ruriko", "password": "<pass>", "auth": { "type": "m.login.registration_token", "token": "<token>" } }
  #   4. Clear TUWUNEL_REGISTRATION_TOKEN (set to empty) and restart.
  #
  # Comment this service out if you are connecting Ruriko to an existing homeserver.
  # See docs/ops/deployment-docker.md for full setup instructions.
  #
  # Alternative: Synapse (see the commented block at the bottom of this file)
  # --------------------------------------------------------------------------
  tuwunel:
    image: ghcr.io/girlbossceo/conduwuit:latest
    container_name: tuwunel
    restart: unless-stopped

    ports:
      # Expose to the host so your Matrix client can connect.
      # Use http://localhost:8008 as the homeserver URL in your client.
      - "${TUWUNEL_HOST:-127.0.0.1}:${TUWUNEL_PORT:-8008}:8008"

    environment:
      CONDUWUIT_SERVER_NAME:              ${TUWUNEL_SERVER_NAME:-localhost}
      CONDUWUIT_DATABASE_PATH:            /var/lib/tuwunel
      CONDUWUIT_ALLOW_REGISTRATION:       ${TUWUNEL_ALLOW_REGISTRATION:-false}
      CONDUWUIT_REGISTRATION_TOKEN:       ${TUWUNEL_REGISTRATION_TOKEN:-}
      CONDUWUIT_ALLOW_FEDERATION:         "false"
      CONDUWUIT_ALLOW_PUBLIC_ROOM_DIRECTORY: "false"
      CONDUWUIT_PORT:                     "8008"
      CONDUWUIT_LOG:                      warn

    volumes:
      - tuwunel-data:/var/lib/tuwunel

    networks:
      - ruriko-net

    healthcheck:
      test: ["CMD", "curl", "-fsSL", "http://localhost:8008/_matrix/client/versions"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 15s

  # --------------------------------------------------------------------------
  # Synapse — alternative Matrix homeserver (optional, disabled by default)
  #
  # To switch to Synapse:
  #   1. Comment out the tuwunel service above and its volume entry.
  #   2. Uncomment this service and the synapse-data volume entry.
  #   3. Set MATRIX_HOMESERVER_TYPE=synapse and MATRIX_SHARED_SECRET in .env.
  #   4. Update depends_on in the ruriko service to reference synapse.
  #   5. Run: docker compose run --rm synapse generate
  # --------------------------------------------------------------------------
  # synapse:
  #   image: matrixdotorg/synapse:latest
  #   container_name: synapse
  #   restart: unless-stopped
  #   environment:
  #     SYNAPSE_SERVER_NAME:    ${SYNAPSE_SERVER_NAME:-localhost}
  #     SYNAPSE_REPORT_STATS:   "no"
  #   volumes:
  #     - synapse-data:/data
  #   networks:
  #     - ruriko-net
  #   healthcheck:
  #     test: ["CMD", "curl", "-fsSL", "http://localhost:8008/_matrix/client/versions"]
  #     interval: 20s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 30s

  # Uncomment if using Synapse:
  # volumes:
  #   synapse-data:
