# Ruriko Docker Compose Stack
#
# Copy .env.example → .env, fill in the required values, then run:
#   docker compose up -d
#
# Services:
#   ruriko   - The Ruriko control plane
#   synapse  - A local Matrix homeserver (optional, comment out if you have one)
#
# Volumes:
#   ruriko-data     - SQLite database and persistent state
#   synapse-data    - Synapse homeserver data (only used when synapse is enabled)

version: "3.9"

networks:
  ruriko-net:
    driver: bridge

volumes:
  ruriko-data:
  synapse-data:

services:

  # --------------------------------------------------------------------------
  # Ruriko — control plane
  # --------------------------------------------------------------------------
  ruriko:
    image: ruriko:latest
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile.ruriko
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
        GIT_TAG: ${GIT_TAG:-v0.0.0}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    container_name: ruriko
    restart: unless-stopped
    depends_on:
      synapse:
        condition: service_healthy

    # Expose the optional health/status endpoint.
    # Remove this block if you set HTTP_ADDR to an empty string.
    ports:
      - "${HTTP_ADDR_HOST:-127.0.0.1}:${HTTP_ADDR_PORT:-8080}:8080"

    environment:
      # --- Matrix connection (required) ---
      MATRIX_HOMESERVER:      ${MATRIX_HOMESERVER}
      MATRIX_USER_ID:         ${MATRIX_USER_ID}
      MATRIX_ACCESS_TOKEN:    ${MATRIX_ACCESS_TOKEN}
      MATRIX_ADMIN_ROOMS:     ${MATRIX_ADMIN_ROOMS}

      # --- Encryption (required) ---
      # Generate with:  openssl rand -hex 32
      RURIKO_MASTER_KEY:      ${RURIKO_MASTER_KEY}

      # --- Optional Matrix settings ---
      MATRIX_ADMIN_SENDERS:   ${MATRIX_ADMIN_SENDERS:-}
      MATRIX_AUDIT_ROOM:      ${MATRIX_AUDIT_ROOM:-}

      # --- Optional Matrix provisioning (account creation) ---
      MATRIX_PROVISIONING_ENABLE:      ${MATRIX_PROVISIONING_ENABLE:-false}
      MATRIX_HOMESERVER_TYPE:          ${MATRIX_HOMESERVER_TYPE:-synapse}
      MATRIX_SHARED_SECRET:            ${MATRIX_SHARED_SECRET:-}
      MATRIX_AGENT_USERNAME_SUFFIX:    ${MATRIX_AGENT_USERNAME_SUFFIX:-}

      # --- Docker runtime (optional) ---
      DOCKER_ENABLE:          ${DOCKER_ENABLE:-false}
      DOCKER_NETWORK:         ${DOCKER_NETWORK:-ruriko-net}

      # --- Storage ---
      DATABASE_PATH:          /data/ruriko.db
      TEMPLATES_DIR:          /templates

      # --- Reconciler ---
      RECONCILE_INTERVAL:     ${RECONCILE_INTERVAL:-30s}

      # --- Health endpoint ---
      HTTP_ADDR:              :8080

      # --- Logging ---
      LOG_LEVEL:              ${LOG_LEVEL:-info}
      LOG_FORMAT:             ${LOG_FORMAT:-json}

    volumes:
      # Persist database across restarts.
      - ruriko-data:/data
      # Agent Gosuto templates — mount your custom templates/ directory here.
      - ../../templates:/templates:ro
      # Allow Ruriko to manage Docker containers on the host.
      # Remove this volume binding if DOCKER_ENABLE=false.
      - /var/run/docker.sock:/var/run/docker.sock:ro

    networks:
      - ruriko-net

    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # --------------------------------------------------------------------------
  # Synapse — local Matrix homeserver (optional)
  #
  # Comment this service out if you are connecting Ruriko to an existing
  # Matrix homeserver.  See docs/ops/deployment-docker.md for setup steps.
  # --------------------------------------------------------------------------
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: synapse
    restart: unless-stopped

    environment:
      SYNAPSE_SERVER_NAME:    ${SYNAPSE_SERVER_NAME:-localhost}
      SYNAPSE_REPORT_STATS:   "no"

    volumes:
      - synapse-data:/data

    networks:
      - ruriko-net

    healthcheck:
      test: ["CMD", "curl", "-fsSL", "http://localhost:8008/_matrix/client/versions"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 30s
